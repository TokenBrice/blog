{{- $lang := .Page.Language.Lang -}}
{{- $categories := index .Site.Data.glossary.categories $lang -}}

<div class="glossary-categories-overview">
    {{- range $categories -}}
    <div class="category-card clickable-category" data-category-id="{{ .id }}" role="button" tabindex="0" title="{{ if eq $lang "fr" }}Cliquer pour filtrer par catégorie{{ else }}Click to filter by category{{ end }}">
        <div class="category-header">
            <div class="category-icon" data-category-id="{{ .id }}"></div>
            <div class="category-title-group">
                <h3 class="category-name">{{ .name }}</h3>
                <span class="category-count">
                    {{- $termCount := len (where (index $.Site.Data.glossary $lang).terms "category" .id) -}}
                    {{ if eq $lang "fr" }}{{ $termCount }} terme{{ if ne $termCount 1 }}s{{ end }}{{ else }}{{ $termCount }} term{{ if ne $termCount 1 }}s{{ end }}{{ end }}
                </span>
            </div>
        </div>
        <p class="category-description">{{ .description }}</p>
    </div>
    {{- end -}}
</div>

<style>
.glossary-categories-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.category-card {
    background: var(--card-background);
    border: 1px solid var(--card-border-color);
    border-left: 4px solid var(--card-border-color);
    border-radius: var(--card-border-radius);
    padding: 1.5rem;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-l1);
}

.category-card.clickable-category {
    cursor: pointer;
    user-select: none;
}

.category-card:hover {
    box-shadow: var(--shadow-l2);
    transform: translateY(-2px);
    border-color: var(--accent-color);
}

.category-card.clickable-category:hover {
    border-left-width: 6px;
}

.category-card:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
}

.category-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
}

.category-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    background: rgba(var(--category-color-rgb, 59, 130, 246), 0.08);
}

.category-card:hover .category-icon {
    background: rgba(var(--category-color-rgb, 59, 130, 246), 0.15);
    transform: scale(1.05);
}

.category-title-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.category-name {
    margin: 0;
    color: var(--card-text-color-main);
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1.2;
}

.category-description {
    margin: 0;
    color: var(--card-text-color-secondary);
    line-height: 1.4;
    font-size: 0.9rem;
}

.category-count {
    background: var(--category-color, var(--accent-color));
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    align-self: flex-start;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .glossary-categories-overview {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
(function() {
    function getCategoryColor(categoryId) {
        const colors = {
            'yields': '#10B981',      // Green - for earning/returns
            'rendements': '#10B981',  // Green (French)
            'risks': '#EF4444',       // Red - for risks/security
            'risques': '#EF4444',     // Red (French)
            'strategies': '#8B5CF6',  // Purple - for strategies
            'stratégies': '#8B5CF6',  // Purple (French)
            'protocols': '#3B82F6',   // Blue - for protocols/platforms
            'protocoles': '#3B82F6',  // Blue (French)
            'tokens': '#F59E0B',      // Amber - for tokens/assets
            'technical': '#6B7280',   // Gray - for technical concepts
            'technique': '#6B7280',   // Gray (French)
            'trading': '#06B6D4',     // Cyan - for trading/AMMs
            'governance': '#EC4899',  // Pink - for governance/DAOs
            'gouvernance': '#EC4899', // Pink (French)
            // Additional unique colors for overlapping categories
            'defi-protocols': '#3B82F6',      // Keep blue for DeFi Protocols
            'trading-amms': '#06B6D4',        // Keep cyan for Trading & AMMs
            'governance-daos': '#EC4899',     // Keep pink for Governance & DAOs
            'technical-concepts': '#6366F1',  // Indigo - distinct from gray
            'lending-borrowing': '#059669',   // Emerald - distinct from green
            'stablecoins': '#F97316',         // Orange - distinct from amber
            'yield-farming': '#10B981'        // Green - same as yields
        };
        return colors[categoryId] || '#6B7280'; // Default to gray
    }
    
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    function shouldUseDarkText(hexColor) {
        const rgb = hexToRgb(hexColor);
        if (!rgb) return false;
        // WCAG relative luminance formula
        const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
        return luminance > 0.5;
    }

    function getCategoryIcon(categoryId) {
        const icons = {
            'yields': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20m5-5l-5 5-5-5"/></svg>`, // Arrow up-down for yields/returns
            'rendements': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20m5-5l-5 5-5-5"/></svg>`,
            'risks': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`, // Shield for risks/security
            'risques': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
            'strategies': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`, // Target for strategies
            'stratégies': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            'protocols': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`, // Link for protocols/platforms
            'protocoles': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`,
            'tokens': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><path d="M15 9.354a4 4 0 1 0 0 5.292"/></svg>`, // Coin for tokens/assets
            'technical': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m15.5-6.5l-4.24 4.24m-6.36 0L1.66 5.34M18.34 18.66l-4.24-4.24m-6.36 0L3.5 18.5"/></svg>`, // Settings for technical concepts
            'technique': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m15.5-6.5l-4.24 4.24m-6.36 0L1.66 5.34M18.34 18.66l-4.24-4.24m-6.36 0L3.5 18.5"/></svg>`,
            'trading': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22,6 13.5,14.5 8.5,9.5 2,16"/><polyline points="16,6 22,6 22,12"/></svg>`, // Trending up for trading/AMMs
            'governance': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7z"/></svg>`, // Heart for governance/community
            'gouvernance': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7z"/></svg>`
        };
        return icons[categoryId] || `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>`; // Default to document icon
    }
    
    function handleCategoryClick(categoryId) {
        // Check if we're on the glossary page and the filtering function exists
        if (typeof window.handleCategoryFilter === 'function') {
            window.handleCategoryFilter(categoryId);
        } else {
            // If the glossary app isn't loaded yet, scroll to it first
            const glossaryApp = document.getElementById('glossary-app');
            if (glossaryApp) {
                glossaryApp.scrollIntoView({ behavior: 'smooth' });
                // Store the category to filter after glossary loads
                window.pendingCategoryFilter = categoryId;
            }
        }
    }
    
    // Apply colors, icons and click handlers when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const categoryCards = document.querySelectorAll('.category-card[data-category-id]');
        categoryCards.forEach(card => {
            const categoryId = card.getAttribute('data-category-id');
            const color = getCategoryColor(categoryId);
            const icon = getCategoryIcon(categoryId);
            const countSpan = card.querySelector('.category-count');
            const iconElement = card.querySelector('.category-icon');
            
            // Apply color to left border
            card.style.borderLeftColor = color;
            
            // Apply color to count badge
            if (countSpan) {
                countSpan.style.backgroundColor = color;
                countSpan.style.color = shouldUseDarkText(color) ? '#1a1a1a' : '#ffffff';
            }
            
            // Convert hex to RGB for background
            const rgb = hexToRgb(color);
            if (rgb) {
                card.style.setProperty('--category-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
            }
            
            // Set CSS custom properties for icon styling
            card.style.setProperty('--category-color', color);
            card.style.setProperty('--category-color-dark', color + 'dd'); // Add some transparency
            
            // Add icon to icon element
            if (iconElement) {
                iconElement.innerHTML = icon;
                iconElement.style.color = color;
            }
            
            // Add click handler
            card.addEventListener('click', function(e) {
                e.preventDefault();
                handleCategoryClick(categoryId);
            });
            
            // Add keyboard support
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleCategoryClick(categoryId);
                }
            });
        });
    });
})();
</script>
